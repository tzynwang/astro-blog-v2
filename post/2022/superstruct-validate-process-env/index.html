<!DOCTYPE html>
<html lang="en" class="astro-D4ZPMAD2">
  <head>
    <!-- Global Metadata -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="sitemap" href="/sitemap-index.xml">
    <meta name="generator" content="Astro v2.10.12">

    <!-- Primary Meta Tags -->
    <title>2022 第14週 學習筆記：使用 superstruct 驗證 process.env 資料</title>
    <meta name="title" content="2022 第14週 學習筆記：使用 superstruct 驗證 process.env 資料">
    <meta name="description" content="">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://tzynwang.github.io/post/2022/superstruct-validate-process-env/">
    <meta property="og:title" content="2022 第14週 學習筆記：使用 superstruct 驗證 process.env 資料">
    <meta property="og:description" content="">
    <meta property="og:image" content="https://tzynwang.github.io/alexander-andrews-mEdKuPYJe1I.jpg">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://tzynwang.github.io/post/2022/superstruct-validate-process-env/">
    <meta property="twitter:title" content="2022 第14週 學習筆記：使用 superstruct 驗證 process.env 資料">
    <meta property="twitter:description" content="">
    <meta property="twitter:image" content="https://tzynwang.github.io/alexander-andrews-mEdKuPYJe1I.jpg">

    <!-- Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/_astro/index.5f60e57f.css" />
<link rel="stylesheet" href="/_astro/2-1-movie-list-i18n-note.5f900e92.css" /></head>
  <body class="astro-D4ZPMAD2">
    <section class="side-contnet astro-D4ZPMAD2">
      <h1 class="astro-D4ZPMAD2">普通文組 2.0</h1>
      <nav class="astro-D4ZPMAD2">
        <a href="/" class="astro-D4ZPMAD2">首頁</a>
        <a href="/archive" class="astro-D4ZPMAD2">全文章歸檔</a>
      </nav>
    </section>
    <section class="main-content astro-D4ZPMAD2">
      
  <div class="post-container astro-QTOKGA5Y">
    <h1 class="astro-QTOKGA5Y">2022 第14週 學習筆記：使用 superstruct 驗證 process.env 資料</h1>
    <div class="info astro-QTOKGA5Y">
      <span class="astro-QTOKGA5Y">2022-04-08 17:07</span>
      <span class="astro-QTOKGA5Y"><span class="astro-2IYMVI75">
  React
</span><span class="astro-2IYMVI75">
  webpack
</span></span>
      <ul class="astro-QTOKGA5Y">
        <li class="toc-2 astro-QTOKGA5Y">
              <a href="#總結" class="astro-QTOKGA5Y">總結</a>
            </li><li class="toc-2 astro-QTOKGA5Y">
              <a href="#版本與環境" class="astro-QTOKGA5Y">版本與環境</a>
            </li><li class="toc-2 astro-QTOKGA5Y">
              <a href="#筆記" class="astro-QTOKGA5Y">筆記</a>
            </li><li class="toc-3 astro-QTOKGA5Y">
              <a href="#使用-superstruct-的優點" class="astro-QTOKGA5Y">使用 superstruct 的優點</a>
            </li><li class="toc-3 astro-QTOKGA5Y">
              <a href="#實作想法梳理" class="astro-QTOKGA5Y">實作想法梳理</a>
            </li><li class="toc-3 astro-QTOKGA5Y">
              <a href="#原始碼" class="astro-QTOKGA5Y">原始碼</a>
            </li><li class="toc-2 astro-QTOKGA5Y">
              <a href="#參考文件" class="astro-QTOKGA5Y">參考文件</a>
            </li>
      </ul>
    </div>
    <h2 id="總結">總結</h2>
<p>使用 <code>create-react-app</code> 建立 React APP 並執行 <code>npm run eject</code> 後，在 <code>config</code> 資料夾內的 <code>env.js</code> 會協助處理 <code>.env</code> 中帶有 <code>REACT_APP_</code> 關鍵字的環境變數，讓開發者可以在 React APP 中讀取 process.env 內容；而如果開發者想要檢驗 process.env 的 schema 並將環境變數由字串型態轉變回布林、數值等資料形式的話，可以搭配 npm package <code>superstruct</code> 來實現</p>
<p>目前未解明：為何投入 <code>webpack.DefinePlugin</code> 後「沒有 <code>REACT_APP_</code> 前綴的環境變數」依舊可以保留字串以外的資料型態 🤔</p>
<h2 id="版本與環境">版本與環境</h2>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #e1e4e8">superstruct: 0.15.4</span></span>
<span class="line"><span style="color: #e1e4e8">webpack: 5.64.4</span></span></code></pre>
<h2 id="筆記">筆記</h2>
<h3 id="使用-superstruct-的優點">使用 superstruct 的優點</h3>
<ul>
<li>除了驗證資料型態（字串、布林、數值等）是否正確，也可檢查資料結構是否符合預期（指定的鍵值是否皆有出現）</li>
<li>提供型別轉換的功能</li>
<li>支援 typescript，定義好的 schema 可挪作 type/interface 使用（本次未使用）</li>
</ul>
<h3 id="實作想法梳理">實作想法梳理</h3>
<ul>
<li><strong>不</strong>將 process.env 的資料檢驗與型別轉換實作在 <code>config/env.js</code> 中，因環境變數最後還是會送至 <code>config/webpack.config.js</code> 中的 <code>webpack.DefinePlugin</code> 轉換回純字串資料</li>
<li>將 process.env 執行型別轉換後的資料保存在 <code>class Env</code> 中，令 process.env 保持字串形式，而在「需要在 React APP 中引用環境變數」時，就從 <code>class Env</code> 取用已經進行型別轉換後的資料</li>
</ul>
<h3 id="原始碼">原始碼</h3>
<script src="https://gist.github.com/tzynwang/02bc3b826d291932f2e322ef5b7b0b29.js"></script>
<p>示範專案 repo：<a href="https://github.com/tzynwang/react-process-env/tree/feature/superstruct">https://github.com/tzynwang/react-process-env/tree/feature/superstruct</a></p>
<ul>
<li><code>src.Model.Env.index.ts</code>
<ul>
<li>第 16~22 行：加上 <code>!</code> 迴避 ts 檢查後回報 <code>Property '...' has no initializer and is not definitely assigned in the constructor</code> 的問題</li>
<li>第 32 行：使用 <code>define</code> 提供 superstruct 自訂義的資料型別</li>
<li>第 33 行：使用 <code>type</code> 允許 process.env 中出現 schema 沒有定義到的鍵值（因 config/env.js 除了回傳帶有 <code>REACT_APP_</code> 的環境變數外，也會納入其他變數內容）；如果資料結構需完全符合定義好的 schema 則可以使用 <code>object</code> 來進行檢查（會在出現額外的鍵值時直接 throw Error）</li>
<li>第 44 行：使用 <code>create</code> 建立型別轉換後的環境變數物件，若 process.env 中有不符合 schema 定義的資料內容，在這階段就會 throw Error</li>
<li>第 47~54 行：將檢驗後的環境變數保存到 <code>class Env</code> 中</li>
</ul>
</li>
<li><code>src.Hook.useEnv.tsx</code>
<ul>
<li>建立該 React APP 中的唯一 <code>Env</code> 實例（singleton pattern）</li>
</ul>
</li>
<li><code>src.App.tsx</code>
<ul>
<li>第 12 行：透過 useEnv 取得 React APP 中的唯一 <code>Env</code> 實例</li>
</ul>
</li>
</ul>
<h2 id="參考文件">參考文件</h2>
<ul>
<li><a href="https://github.com/ianstormtaylor/superstruct#readme">GitHub: Superstruct</a></li>
<li><a href="https://docs.superstructjs.org/">Superstruct Documentation</a></li>
<li><a href="https://stackoverflow.com/questions/49699067/property-has-no-initializer-and-is-not-definitely-assigned-in-the-construc">stackoverflow: Property ’…’ has no initializer and is not definitely assigned in the constructor</a></li>
</ul>
  </div>

      <footer class="astro-QLGQ3ONJ">Tzu Yin (Charlie) 🦊 Made in Taiwan</footer>
    </section>
  </body></html>