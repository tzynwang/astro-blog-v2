<!DOCTYPE html>
<html lang="en" class="astro-D4ZPMAD2">
  <head>
    <!-- Global Metadata -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="sitemap" href="/sitemap-index.xml">
    <meta name="generator" content="Astro v2.10.12">

    <!-- Primary Meta Tags -->
    <title>Alpha Camp「2-3 老爸的私房錢（簡易記帳APP）」技術記錄</title>
    <meta name="title" content="Alpha Camp「2-3 老爸的私房錢（簡易記帳APP）」技術記錄">
    <meta name="description" content="">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://tzynwang.github.io/post/2021/mongoose-note/">
    <meta property="og:title" content="Alpha Camp「2-3 老爸的私房錢（簡易記帳APP）」技術記錄">
    <meta property="og:description" content="">
    <meta property="og:image" content="https://tzynwang.github.io/alexander-andrews-mEdKuPYJe1I.jpg">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://tzynwang.github.io/post/2021/mongoose-note/">
    <meta property="twitter:title" content="Alpha Camp「2-3 老爸的私房錢（簡易記帳APP）」技術記錄">
    <meta property="twitter:description" content="">
    <meta property="twitter:image" content="https://tzynwang.github.io/alexander-andrews-mEdKuPYJe1I.jpg">

    <!-- Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/_astro/index.5f60e57f.css" />
<link rel="stylesheet" href="/_astro/2-1-movie-list-i18n-note.5f900e92.css" /></head>
  <body class="astro-D4ZPMAD2">
    <section class="side-contnet astro-D4ZPMAD2">
      <h1 class="astro-D4ZPMAD2">普通文組 2.0</h1>
      <nav class="astro-D4ZPMAD2">
        <a href="/" class="astro-D4ZPMAD2">首頁</a>
        <a href="/archive" class="astro-D4ZPMAD2">全文章歸檔</a>
      </nav>
    </section>
    <section class="main-content astro-D4ZPMAD2">
      
  <div class="post-container astro-QTOKGA5Y">
    <h1 class="astro-QTOKGA5Y">Alpha Camp「2-3 老爸的私房錢（簡易記帳APP）」技術記錄</h1>
    <div class="info astro-QTOKGA5Y">
      <span class="astro-QTOKGA5Y">2021-05-24 13:38</span>
      <span class="astro-QTOKGA5Y"><span class="astro-2IYMVI75">
  JavaScript
</span></span>
      <ul class="astro-QTOKGA5Y">
        <li class="toc-2 astro-QTOKGA5Y">
              <a href="#總結" class="astro-QTOKGA5Y">總結</a>
            </li><li class="toc-2 astro-QTOKGA5Y">
              <a href="#環境" class="astro-QTOKGA5Y">環境</a>
            </li><li class="toc-2 astro-QTOKGA5Y">
              <a href="#筆記" class="astro-QTOKGA5Y">筆記</a>
            </li><li class="toc-3 astro-QTOKGA5Y">
              <a href="#專案結構" class="astro-QTOKGA5Y">專案結構</a>
            </li><li class="toc-3 astro-QTOKGA5Y">
              <a href="#透過一行腳本在多個資料庫個別產生種子資料" class="astro-QTOKGA5Y">透過一行腳本在多個資料庫個別產生種子資料</a>
            </li><li class="toc-3 astro-QTOKGA5Y">
              <a href="#對-mongodb-進行類似-sql-資料庫的-join-指令" class="astro-QTOKGA5Y">對 mongoDB 進行類似 SQL 資料庫的 join 指令</a>
            </li><li class="toc-3 astro-QTOKGA5Y">
              <a href="#使用-axios-進行-ajax-請求" class="astro-QTOKGA5Y">使用 axios 進行 ajax 請求</a>
            </li>
      </ul>
    </div>
    <h2 id="總結">總結</h2>
<p>以下是本次作業處理到的主要問題：</p>
<ul>
<li>透過一行腳本在多個資料庫個別產生種子資料</li>
<li>透過 mongoose 在 mongoDB 中 join 兩組 collections 之間的資料</li>
<li>使用 axios 進行 ajax 請求，根據使用者選擇的組別顯示相對應的帳目資料（例：選擇「休閒娛樂」的帳目資料，則畫面僅會顯示該類別的帳目，並消費總金額會同步更新）</li>
</ul>
<h2 id="環境">環境</h2>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #e1e4e8">node: 12.20.2</span></span>
<span class="line"><span style="color: #e1e4e8">express: 4.17.1</span></span>
<span class="line"><span style="color: #e1e4e8">express-handlebars: 5.3.2</span></span>
<span class="line"><span style="color: #e1e4e8">mongoose: 5.12.9</span></span>
<span class="line"><span style="color: #e1e4e8">os: Windows_NT 10.0.18363 win32 x64</span></span></code></pre>
<h2 id="筆記">筆記</h2>
<h3 id="專案結構">專案結構</h3>
<p><img src="/2021/mongoose-note/structure.png" alt="本次專案的完整結構圖"></p>
<h3 id="透過一行腳本在多個資料庫個別產生種子資料">透過一行腳本在多個資料庫個別產生種子資料</h3>
<p><code>npm run</code>腳本如右：<code>"seed": "node models/seeds/categorySeeder.js &#x26;&#x26; node models/seeds/recordSeeder.js"</code>
兩份種子腳本的原始碼如下：</p>
<script src="https://gist.github.com/tzynwang/1ff4db97c6defc36b0a2517f13066353.js"></script>
<script src="https://gist.github.com/tzynwang/24a97dfb59507d16988598e5766380ec.js"></script>
<ul>
<li><code>node models/seeds/categorySeeder.js</code>執行完畢後，需確保腳本停止，方可開始執行<code>node models/seeds/recordSeeder.js</code></li>
<li>在<code>categorySeeder.js</code>中，待<code>Categories.create()</code>完成後，串接<code>.then()</code>來停止 db 連線</li>
<li><code>categorySeeder.js</code>結束後，開始執行<code>recordSeeder.js</code></li>
<li>根據 MDN 的<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/forEach#polyfill"><code>forEach()</code> polyfill</a>，<code>forEach()</code>並沒有 await callback function 的機制，故改使用<code>for...of</code>來進行迴圈；相關參考文件如下：
<ul>
<li><a href="https://www.itread01.com/content/1553973607.html">為什麽 array.foreach 不支持 async/await</a></li>
<li><a href="https://www.coreycleary.me/why-does-async-await-in-a-foreach-not-actually-await">Why does async/await in a .forEach not actually await?</a></li>
<li><a href="https://stackoverflow.com/questions/37576685/using-async-await-with-a-foreach-loop">Using async/await with a forEach loop</a></li>
</ul>
</li>
<li>待<code>for...of</code>執行完畢後，再關閉 db 連線，結束<code>recordSeeder.js</code></li>
</ul>
<h3 id="對-mongodb-進行類似-sql-資料庫的-join-指令">對 mongoDB 進行類似 SQL 資料庫的 join 指令</h3>
<script src="https://gist.github.com/tzynwang/623afbb2e2537e196f5c08897f674a94.js"></script>
<ul>
<li>第 49 行的<code>results</code>，在前端透過 axios 接收後進行<code>console.log(response.data)</code>的內容如下：
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #E1E4E8">{</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #9ECBFF">"_id"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"60a3a3f66d1cf025c09c5714"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #9ECBFF">"name"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"早餐"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #9ECBFF">"category"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"餐飲食品"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #9ECBFF">"date"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"2021-05-18"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #9ECBFF">"amount"</span><span style="color: #E1E4E8">: </span><span style="color: #79B8FF">80</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #9ECBFF">"__v"</span><span style="color: #E1E4E8">: </span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #9ECBFF">"iconPair"</span><span style="color: #E1E4E8">: [</span></span>
<span class="line"><span style="color: #E1E4E8">        {</span></span>
<span class="line"><span style="color: #E1E4E8">            </span><span style="color: #9ECBFF">"_id"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"60a3a865b6ccf51988c7cf9b"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">            </span><span style="color: #9ECBFF">"name"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"餐飲食品"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">            </span><span style="color: #9ECBFF">"icon"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"&#x3C;i class=</span><span style="color: #79B8FF">\"</span><span style="color: #9ECBFF">bi bi-cup-straw</span><span style="color: #79B8FF">\"</span><span style="color: #9ECBFF">>&#x3C;/i>"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">            </span><span style="color: #9ECBFF">"__v"</span><span style="color: #E1E4E8">: </span><span style="color: #79B8FF">0</span></span>
<span class="line"><span style="color: #E1E4E8">        }</span></span>
<span class="line"><span style="color: #E1E4E8">    ]</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span>
<span class="line"><span style="color: #E1E4E8">{</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #9ECBFF">"_id"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"60a3a3f66d1cf025c09c5715"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #9ECBFF">"name"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"午餐"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #9ECBFF">"category"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"餐飲食品"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #9ECBFF">"date"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"2021-05-18"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #9ECBFF">"amount"</span><span style="color: #E1E4E8">: </span><span style="color: #79B8FF">120</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #9ECBFF">"__v"</span><span style="color: #E1E4E8">: </span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #9ECBFF">"iconPair"</span><span style="color: #E1E4E8">: [</span></span>
<span class="line"><span style="color: #E1E4E8">        {</span></span>
<span class="line"><span style="color: #E1E4E8">            </span><span style="color: #9ECBFF">"_id"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"60a3a865b6ccf51988c7cf9b"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">            </span><span style="color: #9ECBFF">"name"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"餐飲食品"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">            </span><span style="color: #9ECBFF">"icon"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"&#x3C;i class=</span><span style="color: #79B8FF">\"</span><span style="color: #9ECBFF">bi bi-cup-straw</span><span style="color: #79B8FF">\"</span><span style="color: #9ECBFF">>&#x3C;/i>"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">            </span><span style="color: #9ECBFF">"__v"</span><span style="color: #E1E4E8">: </span><span style="color: #79B8FF">0</span></span>
<span class="line"><span style="color: #E1E4E8">        }</span></span>
<span class="line"><span style="color: #E1E4E8">    ]</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span>
<span class="line"><span style="color: #E1E4E8">{</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #9ECBFF">"_id"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"60a3a3f66d1cf025c09c5716"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #9ECBFF">"name"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"晚餐"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #9ECBFF">"category"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"餐飲食品"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #9ECBFF">"date"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"2021-05-18"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #9ECBFF">"amount"</span><span style="color: #E1E4E8">: </span><span style="color: #79B8FF">100</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #9ECBFF">"__v"</span><span style="color: #E1E4E8">: </span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #9ECBFF">"iconPair"</span><span style="color: #E1E4E8">: [</span></span>
<span class="line"><span style="color: #E1E4E8">        {</span></span>
<span class="line"><span style="color: #E1E4E8">            </span><span style="color: #9ECBFF">"_id"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"60a3a865b6ccf51988c7cf9b"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">            </span><span style="color: #9ECBFF">"name"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"餐飲食品"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">            </span><span style="color: #9ECBFF">"icon"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"&#x3C;i class=</span><span style="color: #79B8FF">\"</span><span style="color: #9ECBFF">bi bi-cup-straw</span><span style="color: #79B8FF">\"</span><span style="color: #9ECBFF">>&#x3C;/i>"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">            </span><span style="color: #9ECBFF">"__v"</span><span style="color: #E1E4E8">: </span><span style="color: #79B8FF">0</span></span>
<span class="line"><span style="color: #E1E4E8">        }</span></span>
<span class="line"><span style="color: #E1E4E8">    ]</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre>
使用<code>$lookup</code>關聯出的結果可透過鍵值<code>iconPair</code>取得</li>
<li>相關參考文件：
<ul>
<li><a href="https://stackoverflow.com/questions/36805784/how-to-join-two-collections-in-mongoose">How to join two collections in mongoose</a></li>
<li><a href="https://docs.mongodb.com/manual/reference/operator/aggregation/lookup/">$lookup (aggregation)</a></li>
<li><a href="https://docs.mongodb.com/manual/reference/operator/aggregation/sum/">$sum (aggregation)</a>：<code>$sum</code>可搭配<code>aggregation</code>來直接回傳某欄位的總計值，本次未使用</li>
</ul>
</li>
</ul>
<h3 id="使用-axios-進行-ajax-請求">使用 axios 進行 ajax 請求</h3>
<p><img src="/2021/mongoose-note/demo.gif" alt="使用 ajax 來請求特定帳目群組的資料"></p>
<script src="https://gist.github.com/tzynwang/5bcb2c3c5e5868bad34b8549277e4878.js"></script>
<ul>
<li>若使用 axios 進行 POST request 的話，需搭配<code>body-parser</code>，並加上<code>app.use(bodyParser.json())</code>，否則無法取得 POST request 送出的資料
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #6A737D">// app.js中需加入以下兩組middleware</span></span>
<span class="line"><span style="color: #E1E4E8">app.</span><span style="color: #B392F0">use</span><span style="color: #E1E4E8">(bodyParser.</span><span style="color: #B392F0">json</span><span style="color: #E1E4E8">());</span></span>
<span class="line"><span style="color: #E1E4E8">app.</span><span style="color: #B392F0">use</span><span style="color: #E1E4E8">(bodyParser.</span><span style="color: #B392F0">urlencoded</span><span style="color: #E1E4E8">({ extended: </span><span style="color: #79B8FF">true</span><span style="color: #E1E4E8"> }));</span></span></code></pre>
</li>
<li>參考文件如下：
<ul>
<li><a href="https://stackoverflow.com/questions/40859299/axios-post-request-body-is-empty-object">Axios post request.body is empty object</a></li>
<li><a href="https://stackoverflow.com/questions/51143730/axios-posting-empty-request">Axios posting empty request</a></li>
<li><a href="https://stackoverflow.com/questions/55593431/cant-receive-data-from-axios-on-api">Can’t receive data from axios on API</a></li>
</ul>
</li>
</ul>
  </div>

      <footer class="astro-QLGQ3ONJ">Tzu Yin (Charlie) 🦊 Made in Taiwan</footer>
    </section>
  </body></html>