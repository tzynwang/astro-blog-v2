<!DOCTYPE html>
<html lang="en" class="astro-D4ZPMAD2">
  <head>
    <!-- Global Metadata -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="sitemap" href="/sitemap-index.xml">
    <meta name="generator" content="Astro v2.10.12">

    <!-- Primary Meta Tags -->
    <title>ã€Œéƒ¨å±¬Express.js Appè‡³Google App Engineã€ç›¸é—œç­†è¨˜</title>
    <meta name="title" content="ã€Œéƒ¨å±¬Express.js Appè‡³Google App Engineã€ç›¸é—œç­†è¨˜">
    <meta name="description" content="">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://tzynwang.github.io/post/2021/express-app-deploy-gcp/">
    <meta property="og:title" content="ã€Œéƒ¨å±¬Express.js Appè‡³Google App Engineã€ç›¸é—œç­†è¨˜">
    <meta property="og:description" content="">
    <meta property="og:image" content="https://tzynwang.github.io/alexander-andrews-mEdKuPYJe1I.jpg">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://tzynwang.github.io/post/2021/express-app-deploy-gcp/">
    <meta property="twitter:title" content="ã€Œéƒ¨å±¬Express.js Appè‡³Google App Engineã€ç›¸é—œç­†è¨˜">
    <meta property="twitter:description" content="">
    <meta property="twitter:image" content="https://tzynwang.github.io/alexander-andrews-mEdKuPYJe1I.jpg">

    <!-- Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/_astro/index.5f60e57f.css" />
<link rel="stylesheet" href="/_astro/2-1-movie-list-i18n-note.5f900e92.css" /></head>
  <body class="astro-D4ZPMAD2">
    <section class="side-contnet astro-D4ZPMAD2">
      <h1 class="astro-D4ZPMAD2">æ™®é€šæ–‡çµ„ 2.0</h1>
      <nav class="astro-D4ZPMAD2">
        <a href="/" class="astro-D4ZPMAD2">é¦–é </a>
        <a href="/archive" class="astro-D4ZPMAD2">å…¨æ–‡ç« æ­¸æª”</a>
      </nav>
    </section>
    <section class="main-content astro-D4ZPMAD2">
      
  <div class="post-container astro-QTOKGA5Y">
    <h1 class="astro-QTOKGA5Y">ã€Œéƒ¨å±¬Express.js Appè‡³Google App Engineã€ç›¸é—œç­†è¨˜</h1>
    <div class="info astro-QTOKGA5Y">
      <span class="astro-QTOKGA5Y">2021-06-25 14:06</span>
      <span class="astro-QTOKGA5Y"><span class="astro-2IYMVI75">
  Express
</span></span>
      <ul class="astro-QTOKGA5Y">
        <li class="toc-2 astro-QTOKGA5Y">
              <a href="#ç¸½çµ" class="astro-QTOKGA5Y">ç¸½çµ</a>
            </li><li class="toc-2 astro-QTOKGA5Y">
              <a href="#ç’°å¢ƒ" class="astro-QTOKGA5Y">ç’°å¢ƒ</a>
            </li><li class="toc-2 astro-QTOKGA5Y">
              <a href="#éƒ¨å±¬å‰è¨­å®š" class="astro-QTOKGA5Y">éƒ¨å±¬å‰è¨­å®š</a>
            </li><li class="toc-3 astro-QTOKGA5Y">
              <a href="#appjs" class="astro-QTOKGA5Y">app.js</a>
            </li><li class="toc-3 astro-QTOKGA5Y">
              <a href="#configmongoosejs" class="astro-QTOKGA5Y">config/mongoose.js</a>
            </li><li class="toc-3 astro-QTOKGA5Y">
              <a href="#appyaml" class="astro-QTOKGA5Y">app.yaml</a>
            </li><li class="toc-3 astro-QTOKGA5Y">
              <a href="#packagejson" class="astro-QTOKGA5Y">package.json</a>
            </li><li class="toc-2 astro-QTOKGA5Y">
              <a href="#éƒ¨å±¬æµç¨‹" class="astro-QTOKGA5Y">éƒ¨å±¬æµç¨‹</a>
            </li><li class="toc-2 astro-QTOKGA5Y">
              <a href="#ç·´ç¿’çµæœ" class="astro-QTOKGA5Y">ç·´ç¿’çµæœ</a>
            </li><li class="toc-2 astro-QTOKGA5Y">
              <a href="#é—œæ–¼ç¨®å­è³‡æ–™" class="astro-QTOKGA5Y">é—œæ–¼ç¨®å­è³‡æ–™</a>
            </li>
      </ul>
    </div>
    <h2 id="ç¸½çµ">ç¸½çµ</h2>
<ul>
<li>åŒæ¨£æ˜¯åœ¨æ­é…ä½¿ç”¨ MongoDB çš„æƒ…å¢ƒä¸‹ï¼Œæ•´é«”æµç¨‹æ¯”æ„Ÿè¦ºæ¯”éƒ¨å±¬è‡³ Heroku ç°¡å–®è¨±å¤š</li>
<li>ç¼ºé»ï¼šç„¡æ³•è™•ç†ã€Œå°è³‡æ–™åº«å°å…¥ç¨®å­è³‡æ–™ã€çš„éœ€æ±‚ï¼›é›–ç„¶ App Engine æä¾›<code>runtime: custom</code>èˆ‡<code>Dockerfile</code>ä¾†è™•ç†ä¸€å®šç¨‹åº¦çš„å®¢è£½åŒ–éœ€æ±‚ï¼Œä½†ç„¡æ³•é…åˆ<code>docker-compose.yml</code>ä¾†å®‰è£ mongoDB</li>
</ul>
<h2 id="ç’°å¢ƒ">ç’°å¢ƒ</h2>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #e1e4e8">Google Cloud SDK: 346.0.0</span></span>
<span class="line"><span style="color: #e1e4e8">os: Windows_NT 10.0.18363 win32 x64</span></span></code></pre>
<h2 id="éƒ¨å±¬å‰è¨­å®š">éƒ¨å±¬å‰è¨­å®š</h2>
<h3 id="appjs">app.js</h3>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #6A737D">// æ–°å¢process.env.PORTï¼Œè®“Appå¯ä»¥è®€å–Google App Engineåˆ†é…çš„åŸ è™Ÿ</span></span>
<span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">port</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> process.env.</span><span style="color: #79B8FF">PORT</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">||</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">5000</span><span style="color: #E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">// è¿½åŠ ä»¥ä¸‹å…§å®¹</span></span>
<span class="line"><span style="color: #E1E4E8">app.</span><span style="color: #B392F0">set</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'trust proxy'</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">true</span><span style="color: #E1E4E8">);</span></span></code></pre>
<ul>
<li>é—œæ–¼<code>app.set('trust proxy', true)</code>
<ul>
<li>åƒè€ƒå®˜æ–¹æ–‡ä»¶å…§å®¹ï¼š<a href="https://cloud.google.com/appengine/docs/standard/nodejs/runtime#https_and_forwarding_proxies">HTTPS and forwarding proxies</a></li>
<li>App Engine terminates HTTPS connections at the load balancer and forwards requests to your application. Some applications need to determine the original request IP and protocol. The userâ€™s IP address is available in the standard X-Forwarded-For header. Applications that require this information should configure their web framework to trust the proxy.</li>
<li>With Express.js, use the trust proxy setting: <code>app.set('trust proxy', true)</code></li>
</ul>
</li>
</ul>
<h3 id="configmongoosejs">config/mongoose.js</h3>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #6A737D">// æ–¼config/mongoose.jsä¸­è¿½åŠ process.env.MONGODB_URI</span></span>
<span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">MONGODB_URI</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> process.env.</span><span style="color: #79B8FF">MONGODB_URI</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">||</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">'mongodb://localhost/login-passport'</span></span>
<span class="line"><span style="color: #E1E4E8">mongoose.</span><span style="color: #B392F0">connect</span><span style="color: #E1E4E8">(</span><span style="color: #79B8FF">MONGODB_URI</span><span style="color: #E1E4E8">, { </span><span style="color: #F97583">...</span><span style="color: #E1E4E8"> })</span></span></code></pre>
<h3 id="appyaml">app.yaml</h3>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #85E89D">runtime</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">nodejs12</span></span>
<span class="line"><span style="color: #85E89D">env_variables</span><span style="color: #E1E4E8">:</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #85E89D">MONGODB_URI</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">'mongodb+srv://&#x3C;DBä½¿ç”¨è€…å¸³è™Ÿ>:&#x3C;DBå¯†ç¢¼>@&#x3C;MongoDB clusteråç¨±>.8glc1.mongodb.net/&#x3C;MongoDB clusteråç¨±>?retryWrites=true&#x26;w=majority'</span></span></code></pre>
<ul>
<li><code>app.yaml</code>æª”æ¡ˆä½æ–¼å°ˆæ¡ˆçš„æ ¹ç›®éŒ„</li>
<li>åƒè€ƒå®˜æ–¹æ–‡ä»¶ï¼š<a href="https://cloud.google.com/appengine/docs/standard/nodejs/runtime">Node.js Runtime Environment</a></li>
</ul>
<h3 id="packagejson">package.json</h3>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #9ECBFF">"scripts"</span><span style="color: #E1E4E8">: {</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #9ECBFF">"start"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"node app.js"</span></span>
<span class="line"><span style="color: #E1E4E8">},</span></span>
<span class="line"><span style="color: #9ECBFF">"engines"</span><span style="color: #E1E4E8">: {</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #9ECBFF">"node"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"^12.0.0"</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre>
<ul>
<li>Google App Engine é è¨­åŸ·è¡Œ<code>node server.js</code>ä¾†å•Ÿå‹• Appï¼Œå¯ä»¥é€é package.json ä¸­çš„<code>start</code> scripts ä¿®æ”¹åŸ·è¡Œå…§å®¹ï¼ˆæœ¬æ¬¡ç·´ç¿’ä¸­æ”¹ç‚º<code>node app.js</code>ï¼‰</li>
<li>åƒè€ƒ<a href="https://cloud.google.com/appengine/docs/standard/nodejs/runtime#application_startup">å®˜æ–¹æ–‡ä»¶</a>ï¼šBy default, the runtime starts your application by running <code>node server.js</code>. If you specify a start script in your <code>package.json</code> file, the runtime <strong>runs the specified start script instead</strong>.</li>
</ul>
<h2 id="éƒ¨å±¬æµç¨‹">éƒ¨å±¬æµç¨‹</h2>
<ol>
<li>åœ¨ Google Cloud Platform å»ºç«‹æ–°å°ˆæ¡ˆ</li>
<li>å®‰è£ Google Cloud SDK</li>
</ol>
<ul>
<li>å®˜æ–¹èªªæ˜æ–‡ä»¶ï¼š<a href="https://cloud.google.com/sdk/docs/install">https://cloud.google.com/sdk/docs/install</a></li>
<li>Google Cloud SDK éœ€æ­é… Pythonï¼Œå®‰è£ SDK æ™‚å‹¾é¸ Install Bundled Python é¸é …å³å¯ï¼Œä¸é ˆå¦å¤–è‡ªè¡Œå®‰è£ Python</li>
</ul>
<ol>
<li>
<p>å®‰è£å®Œç•¢å¾Œï¼Œç§»å‹•åˆ°è¦éƒ¨å±¬åˆ° Google App Engine çš„å°ˆæ¡ˆçš„è³‡æ–™å¤¾ï¼Œåœ¨çµ‚ç«¯æ©Ÿè¼¸å…¥<code>gcloud init</code></p>
</li>
<li>
<p>å®Œæˆå¸ƒç½²å‰è¨­å®šå¾Œï¼Œå³å¯åŸ·è¡Œ<code>gcloud app deploy</code>ï¼Œéƒ¨å±¬å®Œç•¢å¾Œçµ‚ç«¯æ©Ÿæœƒé¡¯ç¤º App URLï¼ˆé¡ä¼¼<code>https://&#x3C;å°ˆæ¡ˆID>.de.r.appspot.com/</code>ï¼‰ï¼Œå¯ç›´æ¥é–‹å•Ÿè©² URL ç€è¦½å°ˆæ¡ˆ</p>
</li>
<li>
<p>è‹¥ URL æ‰“é–‹å¾Œæ²’æœ‰è¼‰å…¥ä»»ä½•å…§å®¹ï¼Œå‰‡é€²å…¥ App Engine â†’ ç‰ˆæœ¬ â†’ è¨ºæ–· â†’ è¨˜éŒ„æª”ä¸­æŸ¥çœ‹éŒ¯èª¤è¨Šæ¯</p>
<p><img src="/2021/express-app-deploy-gcp/gcp_AppEngine_Version.png" alt="demo 1">
<img src="/2021/express-app-deploy-gcp/gcp_log.png" alt="demo 2"></p>
</li>
</ol>
<h2 id="ç·´ç¿’çµæœ">ç·´ç¿’çµæœ</h2>
<ul>
<li>Login practice: <a href="https://complete-verve-317814.de.r.appspot.com/">https://complete-verve-317814.de.r.appspot.com/</a></li>
<li>Movie list (Express.js): <a href="https://academic-genius-317809.de.r.appspot.com/">https://academic-genius-317809.de.r.appspot.com/</a></li>
</ul>
<h2 id="é—œæ–¼ç¨®å­è³‡æ–™">é—œæ–¼ç¨®å­è³‡æ–™</h2>
<ul>
<li>åŸæœ¬ä»¥ç‚ºå¯ä»¥åƒ…é <code>Dockerfile</code>ä¾†è™•ç†<code>npm run seed</code>ï¼Œä¸éå¯¦éš›åŸ·è¡Œå¾Œå¾—åˆ°éŒ¯èª¤è¨Šæ¯<code>MongooseServerSelectionError: connect ECONNREFUSED 127.0.0.1:27017</code></li>
<li>éŒ¯èª¤è¨Šæ¯çš„æ„ç¾©ï¼šç’°å¢ƒä¸­æ²’æœ‰å®‰è£ MongoDB
<ul>
<li><a href="https://stackoverflow.com/questions/46523321/mongoerror-connect-econnrefused-127-0-0-127017">MongoError: connect ECONNREFUSED 127.0.0.1:27017</a>: This happened probably because the <strong>MongoDB service isnâ€™t started</strong>.</li>
</ul>
</li>
<li>ç„¶è€Œ Google App Engine ä¸¦ä¸æ”¯æ´<code>docker-compose</code>ï¼Œæ•…ç„¡æ³•é€²è¡Œã€Œå®‰è£ MongoDB å¾Œå°å…¥ç¨®å­è³‡æ–™ã€æ­¤éœ€æ±‚ï¼Œåƒè€ƒè¨è«–ä¸²ï¼š
<ul>
<li><a href="https://stackoverflow.com/questions/63782456/docker-compose-yml-in-google-cloud-run">docker-compose.yml in Google Cloud Run</a></li>
<li><a href="https://stackoverflow.com/questions/63223193/google-app-engine-run-command-after-deploy">Google App Engine run command after deploy</a></li>
<li><a href="https://stackoverflow.com/questions/39877521/using-docker-compose-within-google-app-engine">Using Docker compose within Google App Engine</a></li>
</ul>
</li>
</ul>
  </div>

      <footer class="astro-QLGQ3ONJ">Tzu Yin (Charlie) ğŸ¦Š Made in Taiwan</footer>
    </section>
  </body></html>