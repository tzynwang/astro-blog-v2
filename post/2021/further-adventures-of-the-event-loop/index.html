<!DOCTYPE html>
<html lang="en" class="astro-D4ZPMAD2">
  <head>
    <!-- Global Metadata -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="sitemap" href="/sitemap-index.xml">
    <meta name="generator" content="Astro v2.10.12">

    <!-- Primary Meta Tags -->
    <title>å†è¨ª event loop</title>
    <meta name="title" content="å†è¨ª event loop">
    <meta name="description" content="">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://tzynwang.github.io/post/2021/further-adventures-of-the-event-loop/">
    <meta property="og:title" content="å†è¨ª event loop">
    <meta property="og:description" content="">
    <meta property="og:image" content="https://tzynwang.github.io/alexander-andrews-mEdKuPYJe1I.jpg">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://tzynwang.github.io/post/2021/further-adventures-of-the-event-loop/">
    <meta property="twitter:title" content="å†è¨ª event loop">
    <meta property="twitter:description" content="">
    <meta property="twitter:image" content="https://tzynwang.github.io/alexander-andrews-mEdKuPYJe1I.jpg">

    <!-- Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/_astro/index.5f60e57f.css" />
<link rel="stylesheet" href="/_astro/2-1-movie-list-i18n-note.5f900e92.css" /></head>
  <body class="astro-D4ZPMAD2">
    <section class="side-contnet astro-D4ZPMAD2">
      <h1 class="astro-D4ZPMAD2">æ™®é€šæ–‡çµ„ 2.0</h1>
      <nav class="astro-D4ZPMAD2">
        <a href="/" class="astro-D4ZPMAD2">é¦–é </a>
        <a href="/archive" class="astro-D4ZPMAD2">å…¨æ–‡ç« æ­¸æª”</a>
      </nav>
    </section>
    <section class="main-content astro-D4ZPMAD2">
      
  <div class="post-container astro-QTOKGA5Y">
    <h1 class="astro-QTOKGA5Y">å†è¨ª event loop</h1>
    <div class="info astro-QTOKGA5Y">
      <span class="astro-QTOKGA5Y">2021-04-14 14:02</span>
      <span class="astro-QTOKGA5Y"><span class="astro-2IYMVI75">
  JavaScript
</span></span>
      <ul class="astro-QTOKGA5Y">
        <li class="toc-2 astro-QTOKGA5Y">
              <a href="#ç¸½çµ" class="astro-QTOKGA5Y">ç¸½çµ</a>
            </li><li class="toc-2 astro-QTOKGA5Y">
              <a href="#å½±ç‰‡æ‘˜è¦further-adventures-of-the-event-loop" class="astro-QTOKGA5Y">å½±ç‰‡æ‘˜è¦ï¼šFurther Adventures of the Event Loop</a>
            </li><li class="toc-2 astro-QTOKGA5Y">
              <a href="#ç­†è¨˜-1" class="astro-QTOKGA5Y">ç­†è¨˜ 1</a>
            </li><li class="toc-3 astro-QTOKGA5Y">
              <a href="#standard-stack" class="astro-QTOKGA5Y">standard stack</a>
            </li><li class="toc-3 astro-QTOKGA5Y">
              <a href="#microtask" class="astro-QTOKGA5Y">microtask</a>
            </li><li class="toc-3 astro-QTOKGA5Y">
              <a href="#macrotask" class="astro-QTOKGA5Y">(macro)task</a>
            </li><li class="toc-2 astro-QTOKGA5Y">
              <a href="#å½±ç‰‡æ¼”ç¤ºmacrotask-queueanimation-callback-queue-èˆ‡-microtask" class="astro-QTOKGA5Y">å½±ç‰‡æ¼”ç¤º(macro)task queueã€animation callback queue èˆ‡ microtask</a>
            </li><li class="toc-3 astro-QTOKGA5Y">
              <a href="#é¡Œç›®è§£æin-the-loop" class="astro-QTOKGA5Y">é¡Œç›®è§£æï¼šIn The Loop</a>
            </li><li class="toc-2 astro-QTOKGA5Y">
              <a href="#å½±ç‰‡æ‘˜è¦scheduling-tasks" class="astro-QTOKGA5Y">å½±ç‰‡æ‘˜è¦ï¼šScheduling Tasks</a>
            </li><li class="toc-2 astro-QTOKGA5Y">
              <a href="#ç­†è¨˜-2" class="astro-QTOKGA5Y">ç­†è¨˜ 2</a>
            </li><li class="toc-2 astro-QTOKGA5Y">
              <a href="#åƒè€ƒæ–‡ä»¶" class="astro-QTOKGA5Y">åƒè€ƒæ–‡ä»¶</a>
            </li>
      </ul>
    </div>
    <h2 id="ç¸½çµ">ç¸½çµ</h2>
<ul>
<li>ç€è¦½å™¨ä¸­çš„ JavaScript ç’°å¢ƒï¼ˆruntimeï¼‰åŒ…å« standard stackã€microtask queue èˆ‡(macro)task queue</li>
<li>ç°¡åŒ–å¾Œçš„ç€è¦½å™¨ event loop æµç¨‹å¦‚ä¸‹ï¼š
<ol>
<li>è™•ç† standard stack ä¸­çš„<strong>æ‰€æœ‰</strong>ä»»å‹™</li>
<li>standard stack æ¸…ç©ºå¾Œï¼Œé–‹å§‹è™•ç† microtask queue ä¸­çš„<strong>æ‰€æœ‰</strong>ä»»å‹™</li>
<li>microtask queue æ¸…ç©ºå¾Œï¼Œé–‹å§‹è™•ç†(macro)task queue ä¸­çš„<strong>ä¸€å€‹</strong>ä»»å‹™</li>
<li>ä¸€æ¬¡ event loop ä¸­å¯èƒ½æœ‰è¤‡æ•¸å€‹(macro)task queueï¼Œevent loop æœƒåŸ·è¡Œæ¯ä¸€å€‹(macro)task queue ä¸­<strong>æœ€æ—©</strong>è¢«åŠ é€²ä¾†çš„<strong>ä¸€å€‹</strong>ä»»å‹™</li>
</ol>
</li>
</ul>
<!--more-->
<h2 id="å½±ç‰‡æ‘˜è¦further-adventures-of-the-event-loop">å½±ç‰‡æ‘˜è¦ï¼šFurther Adventures of the Event Loop</h2>
<iframe width="560" height="315" src="https://www.youtube.com/embed/u1kqx6AenYw" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
<ul>
<li>05:30 An event loop has <strong>one or more task queues</strong>.</li>
<li>08:03 A microtask is promise. There are other things that generate microtasks, but 99.9% of things that you do itâ€™s going to be promises.
<ul>
<li>MDN: JavaScript <strong>promises</strong> and the <strong>Mutation Observer API</strong> both use the <strong>microtask queue</strong> to run their callbacks.</li>
<li>JAVASCRIPT.INFO: <strong>Microtasks are usually created by promises</strong>: an execution of .then/catch/finally handler becomes a microtask. Microtasks are used â€œunder the coverâ€ of await as well, as itâ€™s another form of promise handling.</li>
</ul>
</li>
<li>14:00 (Browserâ€™s event loop) is an infinite loop, weâ€™re going to pick a queue, weâ€™re going to grab the first (macro)task off that queue, run that (macro)task.
<ul>
<li>Then as long as there are microtasks, weâ€™re going to run all those (microtasks).</li>
<li>Then if weâ€™re ready to repaint, weâ€™re going to grab the animation tasks that are currently in the animation queue, and weâ€™re going to run all of those (tasks in animation queue).</li>
<li>And then weâ€™re going to repaint.
<img src="/2021/further-adventures-of-the-event-loop/u1kqx6AenYw-00-14-00.jpg" alt="event loop in browser"></li>
</ul>
</li>
<li>å€‹äººå¿ƒå¾—ï¼šErin Zimmer çš„æ¼”è¬›æ²’æœ‰ç‰¹åˆ¥å€åˆ† standard stack èˆ‡(macro)task queueï¼Œ14:00 å·¦å³çš„ç¸½çµç¨å¾®æœ‰é»ç°¡é™‹ï¼Œæ­é…å…¶ä»–è§£èªªæ–‡ä»¶ä¸€èµ·ç†è§£æ¯”è¼ƒå¥½</li>
</ul>
<h2 id="ç­†è¨˜-1">ç­†è¨˜ 1</h2>
<h3 id="standard-stack">standard stack</h3>
<ul>
<li>æ‰€æœ‰çš„ synchronous functions åœ¨é€™è£¡ç™¼ç”Ÿ</li>
<li>standard stack ä¸­æ‰€æœ‰çš„ä»»å‹™æ¸…ç©ºå¾Œï¼Œæ‰æœƒè¼ªåˆ° microtask queue èˆ‡(macro)task queue(s)</li>
</ul>
<h3 id="microtask">microtask</h3>
<ul>
<li><code>microtask</code>çš„<code>micro</code>èˆ‡ task çš„å°ºå¯¸æ²’æœ‰é—œè¯
<blockquote>
<p>â€¦microtasks, which kind of conveys a sense of size. Microtask sounds smaller than a task, but really what it just meets the <strong>microtask has a higher priority than a (macro)task</strong>. It doesnâ€™t really say anything about the amount of work that you can do. Maybe a bit about what you should do. â€” <a href="https://youtu.be/8eHInw9_U8k">Scheduling Tasks - HTTP 203</a></p>
</blockquote>
</li>
<li><code>promises</code>çš„ callback function æœƒåŠ å…¥ microtask queue åŸ·è¡Œ</li>
<li>å‚³å…¥<code>queueMicrotask()</code>çš„ function ä¹ŸæœƒåŠ å…¥ microtask queue åŸ·è¡Œ</li>
<li>ç€è¦½å™¨æ¯ä¸€æ¬¡çš„ event loop åªæœƒæœ‰ä¸€å€‹ microtask queue</li>
<li>ç€è¦½å™¨æ¯ä¸€æ¬¡çš„ event loop æœƒå°‡ microtask queue ä¸­<strong>æ‰€æœ‰</strong>çš„ microtasks åŸ·è¡Œå®Œç•¢å¾Œï¼Œå†åŸ·è¡Œ(macro)task queue ä¸­çš„ä»»å‹™</li>
</ul>
<h3 id="macrotask">(macro)task</h3>
<ul>
<li>microtask queue æ¸…ç©ºå¾Œï¼Œevent loop æ‰æœƒé–‹å§‹è™•ç†(macro)task queue ä¸­çš„ä»»å‹™</li>
<li>ä»¥ä¸‹çš†å±¬æ–¼(macro)task
<ul>
<li>é€é<code>&#x3C;script src="..."></code>è¼‰å…¥ JavaScript</li>
<li><code>setTimeout</code>çš„ callback function æ™‚é–“å€’æ•¸å®Œæˆå¾Œï¼Œcallback function æœƒè¢«æ¨å…¥(macro)task queue åŸ·è¡Œ</li>
<li>å…¶ä»–å¦‚<code>setInterval</code>ã€<code>setImmediate</code>ã€<code>requestAnimationFrame</code>ã€I/O èˆ‡ UI rendering (repaint)ç­‰ä»»å‹™</li>
</ul>
</li>
<li>ç€è¦½å™¨æ¯ä¸€æ¬¡çš„ event loop å¯èƒ½æœƒæœ‰ä¸€å€‹ã€æˆ–è¤‡æ•¸å€‹(macro)task queue(s)</li>
<li>ç€è¦½å™¨æ¯ä¸€æ¬¡çš„ event loop åªæœƒåŸ·è¡Œ(macro)task queue ä¸­çš„<strong>ä¸€å€‹</strong>(macro)task</li>
</ul>
<h2 id="å½±ç‰‡æ¼”ç¤ºmacrotask-queueanimation-callback-queue-èˆ‡-microtask">å½±ç‰‡æ¼”ç¤º(macro)task queueã€animation callback queue èˆ‡ microtask</h2>
<p>å¤§ç´„åœ¨ 27:37 è™•é–‹å§‹ï¼š</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/cCOL7MC4Pl0?start=1657" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
<h3 id="é¡Œç›®è§£æin-the-loop">é¡Œç›®è§£æï¼šIn The Loop</h3>
<p>ç¬¬ä¸€çµ„ç¨‹å¼ç¢¼ï¼š</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">button</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> document.</span><span style="color: #B392F0">querySelector</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'button'</span><span style="color: #E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">button.</span><span style="color: #B392F0">addEventListener</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'click'</span><span style="color: #E1E4E8">, </span><span style="color: #F97583">function</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">first</span><span style="color: #E1E4E8"> () {</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #79B8FF">Promise</span><span style="color: #E1E4E8">.</span><span style="color: #B392F0">resolve</span><span style="color: #E1E4E8">().</span><span style="color: #B392F0">then</span><span style="color: #E1E4E8">(() </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'microtask 1'</span><span style="color: #E1E4E8">));</span></span>
<span class="line"><span style="color: #E1E4E8">  console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'listener 1'</span><span style="color: #E1E4E8">);</span></span>
<span class="line"><span style="color: #E1E4E8">});</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">button.</span><span style="color: #B392F0">addEventListener</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'click'</span><span style="color: #E1E4E8">, </span><span style="color: #F97583">function</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">second</span><span style="color: #E1E4E8">() {</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #79B8FF">Promise</span><span style="color: #E1E4E8">.</span><span style="color: #B392F0">resolve</span><span style="color: #E1E4E8">().</span><span style="color: #B392F0">then</span><span style="color: #E1E4E8">(() </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'microtask 2'</span><span style="color: #E1E4E8">));</span></span>
<span class="line"><span style="color: #E1E4E8">  console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'listener 2'</span><span style="color: #E1E4E8">);</span></span>
<span class="line"><span style="color: #E1E4E8">});</span></span></code></pre>
<ul>
<li>è¼¸å‡ºé †åºï¼š<code>listener 1</code>ã€<code>microtask 1</code>ã€<code>listener 2</code>ã€<code>microtask 2</code></li>
<li>åˆ†æï¼š
<ol>
<li>ä½¿ç”¨è€…é»é¸<code>button</code>å¾Œï¼Œtask stack åŸ·è¡Œ<code>function first ()</code>çš„<code>console.log('listener 1')</code></li>
<li><code>console.log('microtask 1')</code>è¢«æ¨åˆ° microtask queue ä¸­</li>
<li><code>function first ()</code>çµæŸï¼Œtask stack ç©ºäº†ï¼ŒåŸ·è¡Œ microtask queue ä¸­çš„<code>console.log('microtask 1')</code></li>
<li>é–‹å§‹åŸ·è¡Œ<code>function second()</code>çš„<code>console.log('listener 2')</code></li>
<li><code>console.log('microtask 2')</code>è¢«æ¨åˆ° microtask queue ä¸­</li>
<li><code>function second()</code>çµæŸï¼Œtask stack ç©ºäº†ï¼ŒåŸ·è¡Œ microtask queue ä¸­çš„<code>console.log('microtask 2')</code></li>
</ol>
</li>
</ul>
<p>ç¬¬äºŒçµ„ç¨‹å¼ç¢¼ï¼š</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">button</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> document.</span><span style="color: #B392F0">querySelector</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'button'</span><span style="color: #E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">button.</span><span style="color: #B392F0">addEventListener</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'click'</span><span style="color: #E1E4E8">, </span><span style="color: #F97583">function</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">first</span><span style="color: #E1E4E8"> () {</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #79B8FF">Promise</span><span style="color: #E1E4E8">.</span><span style="color: #B392F0">resolve</span><span style="color: #E1E4E8">().</span><span style="color: #B392F0">then</span><span style="color: #E1E4E8">(() </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'microtask 1'</span><span style="color: #E1E4E8">));</span></span>
<span class="line"><span style="color: #E1E4E8">  console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'listener 1'</span><span style="color: #E1E4E8">);</span></span>
<span class="line"><span style="color: #E1E4E8">})</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">button.</span><span style="color: #B392F0">addEventListener</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'click'</span><span style="color: #E1E4E8">, </span><span style="color: #F97583">function</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">second</span><span style="color: #E1E4E8">() {</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #79B8FF">Promise</span><span style="color: #E1E4E8">.</span><span style="color: #B392F0">resolve</span><span style="color: #E1E4E8">().</span><span style="color: #B392F0">then</span><span style="color: #E1E4E8">(() </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'microtask 2'</span><span style="color: #E1E4E8">));</span></span>
<span class="line"><span style="color: #E1E4E8">  console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'listener 2'</span><span style="color: #E1E4E8">);</span></span>
<span class="line"><span style="color: #E1E4E8">})</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">button.</span><span style="color: #B392F0">click</span><span style="color: #E1E4E8">();</span></span></code></pre>
<ul>
<li>è¼¸å‡ºé †åºï¼š<code>listener 1</code>ã€<code>listener 2</code>ã€<code>microtask 1</code>ã€<code>microtask 2</code></li>
<li>åˆ†æï¼š
<ol>
<li><code>button.click()</code>è¢«åŸ·è¡Œ</li>
<li>åŸ·è¡Œ<code>function first ()</code>çš„<code>console.log('listener 1')</code></li>
<li><code>console.log('microtask 1')</code>è¢«æ¨åˆ° microtask queue ä¸­</li>
<li><code>function first ()</code>çµæŸï¼Œä½†<code>button.click()</code>é‚„åœ¨åŸ·è¡Œï¼ˆtask stack é‚„æœªæ¸…ç©ºï¼‰ï¼Œé‚„æœªè¼ªåˆ° microtask</li>
<li>é–‹å§‹åŸ·è¡Œ<code>function second()</code>çš„<code>console.log('listener 2')</code></li>
<li><code>console.log('microtask 2')</code>è¢«æ¨åˆ° microtask queue ä¸­</li>
<li><code>function second ()</code>çµæŸï¼Œï¼Œ<code>button.click()</code>é‚„åœ¨åŸ·è¡Œï¼ˆtask stack é‚„æœªæ¸…ç©ºï¼‰ï¼Œé‚„æœªè¼ªåˆ° microtask</li>
<li><code>button.click()</code>çµæŸ</li>
<li>task stack ç©ºäº†ï¼ŒåŸ·è¡Œ microtask queue ä¸­çš„<code>console.log('listener 1')</code>èˆ‡<code>console.log('microtask 2')</code></li>
</ol>
</li>
<li>åœ¨ç¬¬ä¸€çµ„ç¨‹å¼ç¢¼ä¸­ï¼Œ<code>function first ()</code>çµæŸå¾Œ task stack å°±æ·¨ç©ºäº†ï¼Œæ•…å¯ä»¥å»è™•ç† microtask queue ä¸­çš„ä»»å‹™</li>
<li>è€Œç¬¬äºŒçµ„ç¨‹å¼ç¢¼å‰‡æ˜¯ï¼š<code>function first ()</code>çµæŸäº†ï¼Œä½†<code>button.click()</code>é‚„æ²’å®Œï¼Œå› ç‚ºé‚„æœ‰ä¸€å€‹<code>function second ()</code>éœ€åŸ·è¡Œï¼›<code>function second ()</code>åŸ·è¡Œå®Œç•¢å¾Œï¼Œ<code>button.click()</code>æ‰ç®—å®Œå…¨çµæŸï¼Œå¯ä»¥å¾ task stack ä¸Šç§»é™¤ï¼Œé€™æ™‚å€™æ‰èƒ½è™•ç† microtask queue ä¸­çš„ä»»å‹™</li>
</ul>
<h2 id="å½±ç‰‡æ‘˜è¦scheduling-tasks">å½±ç‰‡æ‘˜è¦ï¼šScheduling Tasks</h2>
<iframe width="560" height="315" src="https://www.youtube.com/embed/8eHInw9_U8k" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
<ul>
<li>
<p>02:45 Thereâ€™s a way to synchronously call a callback, thereâ€™s a way to call a callback as a (macro)task, and there is a way to call a callback as a microtask</p>
</li>
<li>
<p>03:19 In the end, the event loop is just something that spins around and takes tasks out of different queues. And these <strong>different queues have different priorities</strong>.</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #B392F0">synchronous</span><span style="color: #E1E4E8">(() </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'sync 1'</span><span style="color: #E1E4E8">));</span></span>
<span class="line"><span style="color: #B392F0">task</span><span style="color: #E1E4E8">       (() </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'task 1'</span><span style="color: #E1E4E8">));</span></span>
<span class="line"><span style="color: #B392F0">microtask</span><span style="color: #E1E4E8">  (() </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'microtask 1'</span><span style="color: #E1E4E8">));</span></span>
<span class="line"><span style="color: #B392F0">task</span><span style="color: #E1E4E8">       (() </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'task 2'</span><span style="color: #E1E4E8">));</span></span>
<span class="line"><span style="color: #B392F0">synchronous</span><span style="color: #E1E4E8">(() </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'sync 2'</span><span style="color: #E1E4E8">));</span></span>
<span class="line"><span style="color: #B392F0">microtask</span><span style="color: #E1E4E8">  (() </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">'microtask 2'</span><span style="color: #E1E4E8">));</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">/*</span></span>
<span class="line"><span style="color: #6A737D">output order:</span></span>
<span class="line"><span style="color: #6A737D">sync 1</span></span>
<span class="line"><span style="color: #6A737D">sync 2</span></span>
<span class="line"><span style="color: #6A737D">microtask 1</span></span>
<span class="line"><span style="color: #6A737D">microtask 2</span></span>
<span class="line"><span style="color: #6A737D">task 1</span></span>
<span class="line"><span style="color: #6A737D">task 2</span></span>
<span class="line"><span style="color: #6A737D">*/</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">function</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">synchronous</span><span style="color: #E1E4E8"> (</span><span style="color: #FFAB70">cb</span><span style="color: #E1E4E8">) {</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #B392F0">cb</span><span style="color: #E1E4E8">();</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">function</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">microtask</span><span style="color: #E1E4E8"> (</span><span style="color: #FFAB70">cb</span><span style="color: #E1E4E8">) {</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #B392F0">queueMicrotask</span><span style="color: #E1E4E8">(cb);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #6A737D">// This can work too:</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #6A737D">// Promise.resolve().then(() => cb());</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">function</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">task</span><span style="color: #E1E4E8"> (</span><span style="color: #FFAB70">cb</span><span style="color: #E1E4E8">) {</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #B392F0">setTimeout</span><span style="color: #E1E4E8">(() </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">cb</span><span style="color: #E1E4E8">());</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #6A737D">// A more reliable way without timeout clamping, use MessageChannel():</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #6A737D">// const mc = new MessageChannel();</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #6A737D">// mc.port1.postMessage(null);</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #6A737D">// mc.port2.addEventListener('message', () => {</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #6A737D">//   cb();</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #6A737D">// }, {once: true});</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #6A737D">// mc.port2.start();</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre>
</li>
<li>
<p>03:55 There are some very particular situations where microtasks can come before (macro)tasks, but <strong>only when theyâ€™re queued by the browser</strong>, not by JavaScript.</p>
</li>
<li>
<p>04:57 (The code below) is not correct because the constructor of the promise, the function inside the promise constructor, this is call the <strong>revealing constructor pattern</strong>â€¦will invoke <strong>synchronously</strong>.</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">function</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">microtask</span><span style="color: #E1E4E8"> (</span><span style="color: #FFAB70">cb</span><span style="color: #E1E4E8">) {</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #6A737D">// This can NOT add the callback to microtask queue:</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">new</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">Promise</span><span style="color: #E1E4E8">(</span><span style="color: #FFAB70">resolve</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">cb</span><span style="color: #E1E4E8">();</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">resolve</span><span style="color: #E1E4E8">();</span></span>
<span class="line"><span style="color: #E1E4E8">  });</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D">/*</span></span>
<span class="line"><span style="color: #6A737D">output order will change to:</span></span>
<span class="line"><span style="color: #6A737D">sync 1</span></span>
<span class="line"><span style="color: #6A737D">microtask 1</span></span>
<span class="line"><span style="color: #6A737D">sync 2</span></span>
<span class="line"><span style="color: #6A737D">microtask 2</span></span>
<span class="line"><span style="color: #6A737D">task 1</span></span>
<span class="line"><span style="color: #6A737D">task 2</span></span>
<span class="line"><span style="color: #6A737D">*/</span></span></code></pre>
</li>
<li>
<p>06:31 Most of the time (the code below) will be OK. However, <code>setTimeout()</code> has som very specific rules that when you start <strong>scheduling tasks from within tasks</strong> using this, once you reach a certain depth, <strong>timeout clamping</strong> will occur. So it wonâ€™t schedule the task immediately, but it will start scaling it after 4 milliseconds.</p>
<ul>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/setTimeout#reasons_for_delays">Clamping</a>: In modern browsers, <code>setTimeout()</code>/<code>setInterval()</code> calls are throttled to a minimum of once every 4 ms when successive calls are triggered due to <strong>callback nesting</strong> (where the nesting level is at least a certain depth), or after certain number of successive intervals.</li>
<li>06:59 The spec for this says, wait whatever time you put in there. But then the browser is free to add any kind of padding that they want.</li>
</ul>
</li>
<li>
<p>08:36 The reason that we donâ€™t have a simple function for queuing tasks is <strong>because there are many task queues</strong>. And whenever someone suggests, letâ€™s have a simple function for queuing a task, the next question is, <strong>which queue</strong>?</p>
</li>
</ul>
<h2 id="ç­†è¨˜-2">ç­†è¨˜ 2</h2>
<ul>
<li><a href="https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/#process-nexttick-vs-setimmediate">process.nextTick() vs setImmediate()</a>
<ul>
<li><code>nextTick()</code>åƒ…å­˜æ–¼ nodeï¼Œ<code>setImmediate()</code>ç›®å‰<a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/setImmediate#browser_compatibility">åƒ…æœ‰ IE æ”¯æ´</a></li>
<li>å‚³é€²<code>nextTick()</code>çš„ callback function æœƒæ¯”å‚³é€²<code>setImmediate()</code>çš„ callback function æ›´æ—©è¢« node çš„ event loop åŸ·è¡Œ</li>
<li>å®˜æ–¹åæ§½ï¼šâ€œIn essence, the names should be swapped.â€</li>
</ul>
</li>
</ul>
<h2 id="åƒè€ƒæ–‡ä»¶">åƒè€ƒæ–‡ä»¶</h2>
<ul>
<li><a href="https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/">Tasks, microtasks, queues and schedules</a></li>
<li><a href="https://javascript.info/event-loop">Event loop: microtasks and macrotasks</a></li>
<li><a href="https://javascript.info/microtask-queue">Microtasks</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/HTML_DOM_API/Microtask_guide">Using microtasks in JavaScript with queueMicrotask()</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/EventLoop">Concurrency model and the event loop</a></li>
<li><a href="https://stackoverflow.com/q/25915634/15028185">Difference between microtask and macrotask within an event loop context</a></li>
</ul>
  </div>

      <footer class="astro-QLGQ3ONJ">Tzu Yin (Charlie) ğŸ¦Š Made in Taiwan</footer>
    </section>
  </body></html>